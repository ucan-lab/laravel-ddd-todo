## ドメイン層

- システムのドメインを実装する層
- ドメイン以外の関心ごとは含めない
  - HTTP, DB, キャッシュ等
- Plain Old PHP Object(POPO)で実装し、フレームワークからは独立
  - Facadeやヘルパー関数は使用しない
- 集約、エンティティ、値オブジェクト、ドメインサービス、ドメインイベント

## 集約

トランザクション整合性を保ちながら更新を行うオブジェクトのまとまりです。
リポジトリーに出し入れする単位となります。

集約は主にエンティティと値オブジェクトから構成されます。
集約はなるべく小さく構成するのが望ましいです。

## 集約ルート

集約に含まれる特定のオブジェクトです。
原則的に集約の保持するフィールドの操作はこの集約ルートが一任します。

ルートが操作を一任するという点で「デメテルの法則」に則ったコーディングが求められます

### デメテルの法則

デメテルの法則によると、メソッドを呼び出すオブジェクトは次の４つに限定されます。

- オブジェクト自身
- 引数として渡されたオブジェクト
- インスタンス変数
- 直接インスタンス化したオブジェクト

集約の不変条件からも重要なことはもちろん結合度を下げて保守性を上げる効果も期待できます。

## エンティティ

ドメインモデル、ドメイン知識(ルール/制約)を実現する。
極力、値オブジェクトで構成する。
特にルールや制約がなければプリミティブな型を使用して良い。

常に正しいインスタンスしか存在させないことを意識する。
すべてのインスタンスはコンストラクタ、もしくはファクトリメソッドを経由して生成します。

インスタンス変数は初期化を行った後は値を変更してはいけません。
イミュータブルな構成にしてください。

不用意にセッターメソッドを作らず、インスタンス更新用メソッドはルール・制約に基づいたもののみ公開します。
例えば、setStatus()で値を変える場合はインスタンスを違う目的の処理で使い回されてしまいます。
statusを変えたい場合はpending()やactivate()など目的に合ったメソッドを公開してください。



データベースから取ってきた値は、専用のコンストラクタを設けて全ての属性をバリデーションなしでインスタンスを生成する。

エンティティ、値オブジェクト

このドメイン層ではアプリケーションサービス層、プレゼンテーション層、インフラ層の知識が入り込まないようにします。
ビジネスロジックについてのみ知っている必要があります。

## 値オブジェクト

ユビキタス言語をコードで表現することで、コードを見れば仕様が分かる状態にする
メソッドで定義した演算しかさせないことで誤った使い方を減らす
汎用型ではなく特化型を使う。
例: 「数字」ではなく、「延期回数」
凝集度が上がり、扱いやすい。テストが容易になる。

無理してすべてのスカラー型をラップして値オブジェクトにする必要はない。
